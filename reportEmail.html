<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Report Phishing Emails</title>
    <link rel="stylesheet" href="/style.css"> <!-- Updated path -->
</head>
<body>
    <header class="company-header">
        <div class="logo">
            <a href="/index.html"><img src="/Images/GOCLogo.png" alt="GOCLogo"></a> <!-- Updated path -->
        </div>
        <div class="company-name">
            Department of Phishing Prevention
            <br>
        </div>
    </header>

    <main>
        <div class="rectangle">
            <div class="pps"><h2>Report a Phishing Email</h2></div>
            <br>
            <div id="loading-message" style="text-align: center;">Loading emails...</div>
            <table class="phishing-table" id="email-table">
                <thead>
                    <tr>
                        <th>From</th>
                        <th>Subject</th>
                        <th>Received</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="email-table-body">
                    <!-- Emails will be dynamically populated from the server -->
                </tbody>
            </table>
            <div id="no-emails" style="text-align: center; display: none;">
                No emails available for reporting.
            </div>
        </div>
    </main>

    <footer>
        <div class="pps"></div>
        <div class="footer-links">
            <a href="#">Terms and Conditions</a> | <a href="#">Privacy</a>
        </div>
        <div class="footer-logo">
            <a href="/index.html"><img src="/Images/CanadaLogo.jpg" alt="Canada Logo"></a> <!-- Updated path -->
        </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Hide table initially, show loading message
            document.getElementById('email-table').style.display = 'none';
            
            // Fetch phishing emails from the server
            fetch('https://testrepofinal.onrender.com/phishing-emails') // Updated to Render URL
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(emails => {
                    const tableBody = document.getElementById('email-table-body');
                    const loadingMessage = document.getElementById('loading-message');
                    const noEmailsMessage = document.getElementById('no-emails');
                    const emailTable = document.getElementById('email-table');
                    
                    loadingMessage.style.display = 'none';
                    
                    if (emails.length === 0) {
                        noEmailsMessage.style.display = 'block';
                        return;
                    }
                    
                    emailTable.style.display = 'table';
                    tableBody.innerHTML = ''; // Clear table before adding new rows

                    emails.forEach(email => {
                        const row = document.createElement('tr');

                        const fromCell = document.createElement('td');
                        fromCell.textContent = email.sender || 'Unknown';
                        row.appendChild(fromCell);

                        const subjectCell = document.createElement('td');
                        subjectCell.textContent = email.subject || 'No subject';
                        row.appendChild(subjectCell);

                        const receivedCell = document.createElement('td');
                        receivedCell.textContent = email.received || 'Unknown date';
                        row.appendChild(receivedCell);

                        const actionCell = document.createElement('td');
                        const reportButton = document.createElement('button');
                        reportButton.textContent = 'Report';
                        reportButton.classList.add('report-btn');
                        reportButton.setAttribute('data-email-id', email.id || '');
                        reportButton.addEventListener('click', function() {
                            if (confirm('Are you sure you want to report this email as phishing?')) {
                                const emailId = this.getAttribute('data-email-id');
                                const row = this.closest('tr');
                                const from = row.children[0].textContent;
                                const subject = row.children[1].textContent;
                                const received = row.children[2].textContent;

                                fetch('https://testrepofinal.onrender.com/report-email', { // Updated to Render URL
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json'
                                    },
                                    body: JSON.stringify({ 
                                        from, 
                                        subject, 
                                        received,
                                        image: email.image || '' 
                                    })
                                })
                                .then(response => {
                                    if (!response.ok) {
                                        throw new Error('Reporting failed');
                                    }
                                    return response.json();
                                })
                                .then(data => {
                                    if (data.success) {
                                        alert('Email reported successfully!');
                                        row.remove(); // Remove the row from the table after reporting
                                        
                                        // Show "no emails" message if last email was reported
                                        if (tableBody.children.length === 0) {
                                            emailTable.style.display = 'none';
                                            noEmailsMessage.style.display = 'block';
                                        }
                                    } else {
                                        alert('Error reporting the email: ' + (data.error || 'Unknown error'));
                                    }
                                })
                                .catch(err => {
                                    console.error("Error:", err);
                                    alert('An error occurred while reporting the email');
                                });
                            }
                        });
                        actionCell.appendChild(reportButton);
                        row.appendChild(actionCell);

                        tableBody.appendChild(row);
                    });
                })
                .catch(error => {
                    console.error('Error fetching phishing emails:', error);
                    document.getElementById('loading-message').textContent = 
                        'Error loading emails. Please try again later.';
                    document.getElementById('loading-message').style.color = 'red';
                });
        });
    </script>

    <style>
        .report-btn {
            padding: 5px 10px;
            background-color: #d9534f;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .report-btn:hover {
            background-color: #c9302c;
        }
        
        .report-btn:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
    </style>
</body>
</html>